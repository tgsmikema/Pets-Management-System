%----------------------------------------------------------------------------------------
%	Software
%----------------------------------------------------------------------------------------

\chapter{Software Components}

The software requirements of this project include embedded software, a backend and two frontends. The embedded software will communicate with the hardware and the software backend. The backend will store data and communicate with the frontends, which will display the information to SPCA staff and allow them to enter weights. This section will review existing products and specify our software design. 

\subsection{Prior Art}

\subsection{Embedded}
The first step for the embedded section starts with the communication between the PCB and the Raspberry Pi. We are measuring the voltage of the output signal generated by the instrumentation amplifier to give us an indication of the weight present on the scale. We will also measure the voltage value of the PCB ground and a separate ADC channel, this will allow us to measure the inherent offset in the Pi’s ADC. We can then write firmware to convert the ADC values into weights as the circuitry has been designed to vary the output voltage linearly with weight. 

The measured weight will be the average of multiple samples. The scale should stop measuring once the weight has stabilised within a certain range. Then it will take an average of the samples measured and take that as the weight of the dog. The specifics of the algorithm will be developed through practical testing on a working prototype. 

Once we have these voltages, we can send them to the backend of the website and app via HTTP or HTTPS. (write more on the wifi once we’ve done more stuff)
The workflow for the communication between the Raspberry Pi and the backend is that every time a dog is weighed, the measurements and a scale ID are sent to the backend.The backend will always store the most recent value sent from each scale, but at this stage it is not associated with any dog. Once the user is happy with measurement, they can take the most recent weight and link it with a dog id to store it in the dog database.

We have decided to include a seven-segment display into our design. This is done for the purpose of convenience and reliability. It increases convenience as the user can immediately read the weights. It also adds reliability as the scale would be able to function without wifi, which may occur for several reasons. A shift register is connected to the Raspberry Pi to store the segments that should be lit. The communication between the register and Pi includes several connections - one for shifting the register and one for the data. 

\subsection{Backend}
For the backend, we have used .NET with C Sharp for the Web API endpoints, integrated with a light weight SQLite serverless database for data handling. 

For data tracking, we are planning to have: user login information, centre information, animal information, and chat messages. The information will be stored in a few SQL tables in the database. For a draft plan, here's the initial view of the database entity relationship diagram:

As the above database structure will satisfy the requirement of the SPCA. The backend web API will work with the database to carry out Create, Read, Update, and Delete operations in order to satisfy the business requirements from the SPCA.

Next, for the web API endpoints, here a list according to the requirements:

(Keys: A: admin access; VE: vet access; VO: volunteer access;)
User Operations
\begin{itemize}
  \item Login (A, VE, VO)
  \item Register New User (A)
  \item Edit existing User Access Level (A)
  \item Delete an existing user (A)
  \item Changing Login Password for one's own account(A, VE, VO)
  \item Search for an existing user (A) -> return a List
 \end{itemize}
 Animal Operations
 \begin{itemize}
  \item Add a new Dog Information (VE, VO, A)
  \item Edit a Dog Information (VE, A, VO)
  \item Delete a Dog Information (VE, A)
  \item List Animals in one Centre (VE, VO)
  \item List Animals in All Centres (A)
  \item View a Selected Dog Information(VE, VO, A)
  \item Add a weight for a Dog (Not Secured)
  \item Search for dog in current centre (A, VE, VO)
  \item Search for dog across all centres (A) 
  \item Toggle Flag for a selected Dog (A, VE)
  \item Toggle Alert for a selected Dog (A, VE)
  \item Export dogs data (A)
 \end{itemize}
 Chat Operations
 \begin{itemize}
  \item Send Chat Message (A, VE, VO)
  \item Retrieve Own Chat History (A, VE, VO) 
 \end{itemize}

According to the Web API endpoint listed above, there are categorised into three main components to satisfy the main requirements.

Most of the endpoints will be secured with Basic Authentication that is configurable as part of the .NET framework. This means Authentication header for HTTP requests will be needed to access most of the secured API endpoints. Username and Password combination as an encoded string will be sent over the secure HTTPS network to eliminate the chance of being compromised. On the other hand, Basic Authentication will support the distinction of different user types, therefore, we can further secure the access level of different users on the API, not only from the front end of the application, in order to minimise the chance for API endpoints to be abused. For the single endpoint of hardware access for sending over weight data, it is not secured due to the added complexity of implementing it. However, we will add a pseudo password string so any request coming through this API that does not contain this string will be ignored.

\subsection{Frontends}
We have decided to create two front-end frameworks: a mobile application built in Android Studio, and a web application built in React JS. Both applications will have the same functionality so that users can easily switch between both platforms, however we will not support real-time updates. Creating a mobile application is ideal for vets and volunteers to use while they are on the go, and they can easily record dogs weight with the scales wherever they are. The web application will be helpful for administrators to track trends across centres, and export data to use in excel and other workflows. 

The key functionalities that will be supplied are:
\begin{itemize}
  \item Users can login and logout of their accounts, and change their password
  \item Admin can view dogs across all centres, vets and volunteers are restricted to the centre that they work in
  \item Any user can create a new dog, but volunteers cannot edit or delete existing dogs
  \item Users can access a dogs information and their past weights, and add a new weight
  \item Dogs can be ‘flagged’ by vets and admin, indicating alarming weight change
  \item There can be an ‘alert’ on a dog, indicating that they need to be weighed
  \item Users can see trends as pie charts and line charts across the centres that they have access to, and can export this data as .csv files
  \item Users can send messages to each other within the application
  \item Admins can create new users, and edit the access of existing users
 \end{itemize}
 
 Below is a look at the UI of the mobile application. The web application has been omitted for space reasons, and it follows a very similar pattern to the mobile application. The user can navigate through the main screens by the navigation bar on the bottom, and the red arrows show navigation to additional screens. 
 

